<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Avalon Firmware: System/stm_utils/Src/supercap_controllers.cpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Avalon Firmware
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('supercap__controllers_8cpp.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle"><div class="title">supercap_controllers.cpp File Reference</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="supercap__controllers_8hpp_source.html">supercap_controllers.hpp</a>&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="define-members" name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a0c23b23ccd168233516afb335a2ae040" id="r_a0c23b23ccd168233516afb335a2ae040"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a0c23b23ccd168233516afb335a2ae040">ALPHA_PID_POWER</a>&#160;&#160;&#160;0.98f</td></tr>
<tr class="memdesc:a0c23b23ccd168233516afb335a2ae040"><td class="mdescLeft">&#160;</td><td class="mdescRight">Low-pass filter alpha constant for smoothing power signal.  <br /></td></tr>
<tr class="separator:a0c23b23ccd168233516afb335a2ae040"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a4f1940289143f288690030b42bd9bb40" id="r_a4f1940289143f288690030b42bd9bb40"><td class="memItemLeft" align="right" valign="top">static float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a4f1940289143f288690030b42bd9bb40">low_pass_filter</a> (float current_value, float previous_value, float alpha)</td></tr>
<tr class="memdesc:a4f1940289143f288690030b42bd9bb40"><td class="mdescLeft">&#160;</td><td class="mdescRight">First-order low pass filter.  <br /></td></tr>
<tr class="separator:a4f1940289143f288690030b42bd9bb40"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a510d23db2a669094d85a6db0f28c28fc" id="r_a510d23db2a669094d85a6db0f28c28fc"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a510d23db2a669094d85a6db0f28c28fc">update_pid_maxpow</a> ()</td></tr>
<tr class="memdesc:a510d23db2a669094d85a6db0f28c28fc"><td class="mdescLeft">&#160;</td><td class="mdescRight">Updates the internal PID limits for chassis power.  <br /></td></tr>
<tr class="separator:a510d23db2a669094d85a6db0f28c28fc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adf3e99356aa7839ba54e74a5a15bb49d" id="r_adf3e99356aa7839ba54e74a5a15bb49d"><td class="memItemLeft" align="right" valign="top">static uint16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#adf3e99356aa7839ba54e74a5a15bb49d">moving_average</a> (<a class="el" href="structmov__avrg__filter.html">mov_avrg_filter</a> &amp;filter, uint16_t new_sample)</td></tr>
<tr class="memdesc:adf3e99356aa7839ba54e74a5a15bb49d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculates a moving average on a circular buffer filter structure.  <br /></td></tr>
<tr class="separator:adf3e99356aa7839ba54e74a5a15bb49d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aba3127849c2e3b057ae866a50726d0dc" id="r_aba3127849c2e3b057ae866a50726d0dc"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#aba3127849c2e3b057ae866a50726d0dc">sample_adc</a> ()</td></tr>
<tr class="memdesc:aba3127849c2e3b057ae866a50726d0dc"><td class="mdescLeft">&#160;</td><td class="mdescRight">Samples and filters ADC data from both ADC1 and ADC2.  <br /></td></tr>
<tr class="separator:aba3127849c2e3b057ae866a50726d0dc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a900e71684e129e79e1783534a3debe3b" id="r_a900e71684e129e79e1783534a3debe3b"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a900e71684e129e79e1783534a3debe3b">stop_gates_pwm</a> ()</td></tr>
<tr class="memdesc:a900e71684e129e79e1783534a3debe3b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Disables all HRTIM PWM outputs driving the power gates.  <br /></td></tr>
<tr class="separator:a900e71684e129e79e1783534a3debe3b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a96b593097aa92fa0833e7133289303d0" id="r_a96b593097aa92fa0833e7133289303d0"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a96b593097aa92fa0833e7133289303d0">stop_loop</a> ()</td></tr>
<tr class="memdesc:a96b593097aa92fa0833e7133289303d0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Internal version of loop stop (non-class variant).  <br /></td></tr>
<tr class="separator:a96b593097aa92fa0833e7133289303d0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7dd54fc66122a231da37b565f13d23c5" id="r_a7dd54fc66122a231da37b565f13d23c5"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a7dd54fc66122a231da37b565f13d23c5">softwareReset</a> ()</td></tr>
<tr class="memdesc:a7dd54fc66122a231da37b565f13d23c5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Forces a software reset of the MCU.  <br /></td></tr>
<tr class="separator:a7dd54fc66122a231da37b565f13d23c5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2f0721213d637875e8d354705ca5e309" id="r_a2f0721213d637875e8d354705ca5e309"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a2f0721213d637875e8d354705ca5e309">idle_mode</a> ()</td></tr>
<tr class="memdesc:a2f0721213d637875e8d354705ca5e309"><td class="mdescLeft">&#160;</td><td class="mdescRight">Transitions the system into idle mode safely.  <br /></td></tr>
<tr class="separator:a2f0721213d637875e8d354705ca5e309"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6b15df3bf8a89c80f9b0555a17081f5d" id="r_a6b15df3bf8a89c80f9b0555a17081f5d"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a6b15df3bf8a89c80f9b0555a17081f5d">update_dutyCycle</a> (float dutyRatio)</td></tr>
<tr class="memdesc:a6b15df3bf8a89c80f9b0555a17081f5d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Updates the duty cycle for both half-bridges using the HRTIM peripheral.  <br /></td></tr>
<tr class="separator:a6b15df3bf8a89c80f9b0555a17081f5d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a578660a3d9280d61ffaa4b3c3fd1492a" id="r_a578660a3d9280d61ffaa4b3c3fd1492a"><td class="memItemLeft" align="right" valign="top">static float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a578660a3d9280d61ffaa4b3c3fd1492a">get_PID</a> (<a class="el" href="struct_loop_ctrl___p_i_d.html">LoopCtrl_PID</a> *pid_struct, float ref, float feedback, float ff_model)</td></tr>
<tr class="memdesc:a578660a3d9280d61ffaa4b3c3fd1492a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Executes a single PID computation and clamps the result.  <br /></td></tr>
<tr class="separator:a578660a3d9280d61ffaa4b3c3fd1492a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0b640a76fe53e2bdb8125a78d8f09a3d" id="r_a0b640a76fe53e2bdb8125a78d8f09a3d"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a0b640a76fe53e2bdb8125a78d8f09a3d">all_safety_checks</a> ()</td></tr>
<tr class="memdesc:a0b640a76fe53e2bdb8125a78d8f09a3d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Runs all safety checks for voltage and current conditions.  <br /></td></tr>
<tr class="separator:a0b640a76fe53e2bdb8125a78d8f09a3d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3fdc9bc0c7f34cdfebf5ad8775557b8f" id="r_a3fdc9bc0c7f34cdfebf5ad8775557b8f"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a3fdc9bc0c7f34cdfebf5ad8775557b8f">loop_update</a> ()</td></tr>
<tr class="memdesc:a3fdc9bc0c7f34cdfebf5ad8775557b8f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Updates the control loop at each HRTIM callback cycle.  <br /></td></tr>
<tr class="separator:a3fdc9bc0c7f34cdfebf5ad8775557b8f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a96056a8046434e0683c4c4b5cce9c26e" id="r_a96056a8046434e0683c4c4b5cce9c26e"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a96056a8046434e0683c4c4b5cce9c26e">safety_change_level</a> (uint8_t Item, uint8_t Level)</td></tr>
<tr class="memdesc:a96056a8046434e0683c4c4b5cce9c26e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Safely updates the level of a safety item if required.  <br /></td></tr>
<tr class="separator:a96056a8046434e0683c4c4b5cce9c26e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa6f1aee2abb42683116182bcd70bc2d9" id="r_aa6f1aee2abb42683116182bcd70bc2d9"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#aa6f1aee2abb42683116182bcd70bc2d9">safety_check_voltages</a> ()</td></tr>
<tr class="memdesc:aa6f1aee2abb42683116182bcd70bc2d9"><td class="mdescLeft">&#160;</td><td class="mdescRight">Performs safety checks on both chassis and supercapacitor voltages.  <br /></td></tr>
<tr class="separator:aa6f1aee2abb42683116182bcd70bc2d9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae89ccaa857bc05c4a7c5d7725ac597dd" id="r_ae89ccaa857bc05c4a7c5d7725ac597dd"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ae89ccaa857bc05c4a7c5d7725ac597dd">safety_check_currents</a> ()</td></tr>
<tr class="memdesc:ae89ccaa857bc05c4a7c5d7725ac597dd"><td class="mdescLeft">&#160;</td><td class="mdescRight">Checks for overcurrent conditions on both the chassis and the supercapacitor.  <br /></td></tr>
<tr class="separator:ae89ccaa857bc05c4a7c5d7725ac597dd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7dd450a88d47fb27ab95c1178d2e887c" id="r_a7dd450a88d47fb27ab95c1178d2e887c"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a7dd450a88d47fb27ab95c1178d2e887c">AnalogSignal_ADCDMA_OVRStop</a> (ADC_HandleTypeDef *hadc)</td></tr>
<tr class="memdesc:a7dd450a88d47fb27ab95c1178d2e887c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Stops the ongoing ADC DMA conversion in case of overrun.  <br /></td></tr>
<tr class="separator:a7dd450a88d47fb27ab95c1178d2e887c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a973a9131afb2a029427976a0395c0fc2" id="r_a973a9131afb2a029427976a0395c0fc2"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a973a9131afb2a029427976a0395c0fc2">AnalogSignal_ADCDMA_OVRRecovery</a> (ADC_HandleTypeDef *hadc)</td></tr>
<tr class="memdesc:a973a9131afb2a029427976a0395c0fc2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Recovers ADC and DMA after an overrun (OVR) condition.  <br /></td></tr>
<tr class="separator:a973a9131afb2a029427976a0395c0fc2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a81577a47369bdf873ab44bcacff40396" id="r_a81577a47369bdf873ab44bcacff40396"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a81577a47369bdf873ab44bcacff40396">HAL_HRTIM_RepetitionEventCallback</a> (HRTIM_HandleTypeDef *hhrtim, uint32_t TimerIdx)</td></tr>
<tr class="memdesc:a81577a47369bdf873ab44bcacff40396"><td class="mdescLeft">&#160;</td><td class="mdescRight">Main control loop callback called at each HRTIM repetition event.  <br /></td></tr>
<tr class="separator:a81577a47369bdf873ab44bcacff40396"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="var-members" name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a55509e1a9816b26433393148b19e8dcf" id="r_a55509e1a9816b26433393148b19e8dcf"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a55509e1a9816b26433393148b19e8dcf">Pchassis_output</a></td></tr>
<tr class="memdesc:a55509e1a9816b26433393148b19e8dcf"><td class="mdescLeft">&#160;</td><td class="mdescRight">Output variables used in control and monitoring.  <br /></td></tr>
<tr class="separator:a55509e1a9816b26433393148b19e8dcf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac0e82031947d3d4d9f2cf037a5f95010" id="r_ac0e82031947d3d4d9f2cf037a5f95010"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ac0e82031947d3d4d9f2cf037a5f95010">icap_output</a></td></tr>
<tr class="memdesc:ac0e82031947d3d4d9f2cf037a5f95010"><td class="mdescLeft">&#160;</td><td class="mdescRight">PID-calculated reference current for supercap.  <br /></td></tr>
<tr class="separator:ac0e82031947d3d4d9f2cf037a5f95010"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a60677df115fa0dc78ceaf25cc7adf6f3" id="r_a60677df115fa0dc78ceaf25cc7adf6f3"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a60677df115fa0dc78ceaf25cc7adf6f3">duty_ratio_output</a></td></tr>
<tr class="memdesc:a60677df115fa0dc78ceaf25cc7adf6f3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Raw PID output for duty ratio.  <br /></td></tr>
<tr class="separator:a60677df115fa0dc78ceaf25cc7adf6f3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af30d8fa4b89fd391c7c55037f2c66328" id="r_af30d8fa4b89fd391c7c55037f2c66328"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#af30d8fa4b89fd391c7c55037f2c66328">out_duty_ratio_output</a></td></tr>
<tr class="memdesc:af30d8fa4b89fd391c7c55037f2c66328"><td class="mdescLeft">&#160;</td><td class="mdescRight">Clamped and validated duty ratio to apply.  <br /></td></tr>
<tr class="separator:af30d8fa4b89fd391c7c55037f2c66328"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0fd96139ccb71c248b4fe6a33a4226d0" id="r_a0fd96139ccb71c248b4fe6a33a4226d0"><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a0fd96139ccb71c248b4fe6a33a4226d0">max_chassis_power</a> = 45</td></tr>
<tr class="memdesc:a0fd96139ccb71c248b4fe6a33a4226d0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Max allowed chassis power under RMUC rules.  <br /></td></tr>
<tr class="separator:a0fd96139ccb71c248b4fe6a33a4226d0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afc1d28cfbce795d6ea954ebe725241f5" id="r_afc1d28cfbce795d6ea954ebe725241f5"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#afc1d28cfbce795d6ea954ebe725241f5">temperature</a> = 0.0f</td></tr>
<tr class="memdesc:afc1d28cfbce795d6ea954ebe725241f5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Global sensing variables updated during each loop.  <br /></td></tr>
<tr class="separator:afc1d28cfbce795d6ea954ebe725241f5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a04670db48f9ecf425c973b0b4c42fa7e" id="r_a04670db48f9ecf425c973b0b4c42fa7e"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a04670db48f9ecf425c973b0b4c42fa7e">duty_ratio</a> = 0.9f</td></tr>
<tr class="separator:a04670db48f9ecf425c973b0b4c42fa7e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aca6f1f4aeb1f4203dc361f5a66b5e785" id="r_aca6f1f4aeb1f4203dc361f5a66b5e785"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#aca6f1f4aeb1f4203dc361f5a66b5e785">cap_voltage</a> = 0.0f</td></tr>
<tr class="separator:aca6f1f4aeb1f4203dc361f5a66b5e785"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abe6e2082cb3bc83efd0c83f6c75adde1" id="r_abe6e2082cb3bc83efd0c83f6c75adde1"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#abe6e2082cb3bc83efd0c83f6c75adde1">chassis_voltage</a> = 0.0f</td></tr>
<tr class="memdesc:abe6e2082cb3bc83efd0c83f6c75adde1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Extern global values for chassis voltage and battery current (used across control loops and diagnostics).  <br /></td></tr>
<tr class="separator:abe6e2082cb3bc83efd0c83f6c75adde1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0bb2bcf0f70d5bb5657012d03d05ee4b" id="r_a0bb2bcf0f70d5bb5657012d03d05ee4b"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a0bb2bcf0f70d5bb5657012d03d05ee4b">cap_current</a> = 0.0f</td></tr>
<tr class="separator:a0bb2bcf0f70d5bb5657012d03d05ee4b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaecc091ac17639abe1eb50af6f0cb7fb" id="r_aaecc091ac17639abe1eb50af6f0cb7fb"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#aaecc091ac17639abe1eb50af6f0cb7fb">battery_current</a> = 0.0f</td></tr>
<tr class="separator:aaecc091ac17639abe1eb50af6f0cb7fb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a46c7e940e741ba548759a21f902118a4" id="r_a46c7e940e741ba548759a21f902118a4"><td class="memItemLeft" align="right" valign="top">static uint16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a46c7e940e741ba548759a21f902118a4">ADC_sampled_data</a> [5]</td></tr>
<tr class="memdesc:a46c7e940e741ba548759a21f902118a4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Intermediate ADC buffer after averaging.  <br /></td></tr>
<tr class="separator:a46c7e940e741ba548759a21f902118a4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1e54fa0af2d142c1cf2cec156e08e34b" id="r_a1e54fa0af2d142c1cf2cec156e08e34b"><td class="memItemLeft" align="right" valign="top">static uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a1e54fa0af2d142c1cf2cec156e08e34b">is_init</a> = false</td></tr>
<tr class="memdesc:a1e54fa0af2d142c1cf2cec156e08e34b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Internal state variables for control loop execution.  <br /></td></tr>
<tr class="separator:a1e54fa0af2d142c1cf2cec156e08e34b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2e86f659ad07cfa468b741a118bcae23" id="r_a2e86f659ad07cfa468b741a118bcae23"><td class="memItemLeft" align="right" valign="top">static uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a2e86f659ad07cfa468b741a118bcae23">in_loop</a> = false</td></tr>
<tr class="memdesc:a2e86f659ad07cfa468b741a118bcae23"><td class="mdescLeft">&#160;</td><td class="mdescRight">True if control is actively running.  <br /></td></tr>
<tr class="separator:a2e86f659ad07cfa468b741a118bcae23"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9ad0a1ea7261d776caf4fafe278338fb" id="r_a9ad0a1ea7261d776caf4fafe278338fb"><td class="memItemLeft" align="right" valign="top">static uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a9ad0a1ea7261d776caf4fafe278338fb">safetyChangeTrigger</a></td></tr>
<tr class="memdesc:a9ad0a1ea7261d776caf4fafe278338fb"><td class="mdescLeft">&#160;</td><td class="mdescRight">Tracks whether a safety level transition occurred.  <br /></td></tr>
<tr class="separator:a9ad0a1ea7261d776caf4fafe278338fb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:add29c3bfa7876f2b1d4b4685782829bb" id="r_add29c3bfa7876f2b1d4b4685782829bb"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="struct_loop_ctrl___p_i_d.html">LoopCtrl_PID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#add29c3bfa7876f2b1d4b4685782829bb">pid</a> [5]</td></tr>
<tr class="memdesc:add29c3bfa7876f2b1d4b4685782829bb"><td class="mdescLeft">&#160;</td><td class="mdescRight">Array of PID control structures.  <br /></td></tr>
<tr class="separator:add29c3bfa7876f2b1d4b4685782829bb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad8f99c940b2cbb9852469dc445d114fb" id="r_ad8f99c940b2cbb9852469dc445d114fb"><td class="memItemLeft" align="right" valign="top">static float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ad8f99c940b2cbb9852469dc445d114fb">I_supercap_last</a> = 0.0f</td></tr>
<tr class="memdesc:ad8f99c940b2cbb9852469dc445d114fb"><td class="mdescLeft">&#160;</td><td class="mdescRight">Stores last supercap current reference.  <br /></td></tr>
<tr class="separator:ad8f99c940b2cbb9852469dc445d114fb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adc0f512c64dfad893de755ec0dc721e0" id="r_adc0f512c64dfad893de755ec0dc721e0"><td class="memItemLeft" align="right" valign="top"><a class="el" href="supercap__controllers_8hpp.html#aa0e9b7ff7bcdd512c6fe7530def28d17">Mode_ModeTypedef</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#adc0f512c64dfad893de755ec0dc721e0">current_mode</a> = <a class="el" href="supercap__controllers_8hpp.html#aa0e9b7ff7bcdd512c6fe7530def28d17aebc81705969b8c5ae986b0b2ec08d1d5">normal</a></td></tr>
<tr class="memdesc:adc0f512c64dfad893de755ec0dc721e0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Current control mode (normal, idle, etc.)  <br /></td></tr>
<tr class="separator:adc0f512c64dfad893de755ec0dc721e0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a279987673281ac0b5a019326653e3520" id="r_a279987673281ac0b5a019326653e3520"><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a279987673281ac0b5a019326653e3520">safetyItemLevel</a> [8]</td></tr>
<tr class="memdesc:a279987673281ac0b5a019326653e3520"><td class="mdescLeft">&#160;</td><td class="mdescRight">Tracks safety status per monitored item.  <br /></td></tr>
<tr class="separator:a279987673281ac0b5a019326653e3520"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a id="a0c23b23ccd168233516afb335a2ae040" name="a0c23b23ccd168233516afb335a2ae040"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0c23b23ccd168233516afb335a2ae040">&#9670;&#160;</a></span>ALPHA_PID_POWER</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define ALPHA_PID_POWER&#160;&#160;&#160;0.98f</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Low-pass filter alpha constant for smoothing power signal. </p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="a0b640a76fe53e2bdb8125a78d8f09a3d" name="a0b640a76fe53e2bdb8125a78d8f09a3d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0b640a76fe53e2bdb8125a78d8f09a3d">&#9670;&#160;</a></span>all_safety_checks()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void all_safety_checks </td>
          <td>(</td>
          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Runs all safety checks for voltage and current conditions. </p>
<p>Combines the voltage and current safety check routines if the system is initialized. </p>

</div>
</div>
<a id="a973a9131afb2a029427976a0395c0fc2" name="a973a9131afb2a029427976a0395c0fc2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a973a9131afb2a029427976a0395c0fc2">&#9670;&#160;</a></span>AnalogSignal_ADCDMA_OVRRecovery()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void AnalogSignal_ADCDMA_OVRRecovery </td>
          <td>(</td>
          <td class="paramtype">ADC_HandleTypeDef *</td>          <td class="paramname"><span class="paramname"><em>hadc</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Recovers ADC and DMA after an overrun (OVR) condition. </p>
<p>Clears error flags and restarts the ADC and DMA modules to restore normal operation. Required to recover from transient ADC DMA overflows due to latency or missed callbacks.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">hadc</td><td>Pointer to the ADC handle that experienced overrun. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a7dd450a88d47fb27ab95c1178d2e887c" name="a7dd450a88d47fb27ab95c1178d2e887c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7dd450a88d47fb27ab95c1178d2e887c">&#9670;&#160;</a></span>AnalogSignal_ADCDMA_OVRStop()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void AnalogSignal_ADCDMA_OVRStop </td>
          <td>(</td>
          <td class="paramtype">ADC_HandleTypeDef *</td>          <td class="paramname"><span class="paramname"><em>hadc</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Stops the ongoing ADC DMA conversion in case of overrun. </p>
<p>This is a low-level emergency stop. It halts the ADC immediately to prevent further data corruption.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">hadc</td><td>Pointer to the ADC handle. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a578660a3d9280d61ffaa4b3c3fd1492a" name="a578660a3d9280d61ffaa4b3c3fd1492a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a578660a3d9280d61ffaa4b3c3fd1492a">&#9670;&#160;</a></span>get_PID()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static float get_PID </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="struct_loop_ctrl___p_i_d.html">LoopCtrl_PID</a> *</td>          <td class="paramname"><span class="paramname"><em>pid_struct</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float</td>          <td class="paramname"><span class="paramname"><em>ref</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float</td>          <td class="paramname"><span class="paramname"><em>feedback</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float</td>          <td class="paramname"><span class="paramname"><em>ff_model</em></span>&#160;)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Executes a single PID computation and clamps the result. </p>
<p>Applies the PID algorithm using the CMSIS-DSP library. The output is adjusted with a feedforward term. Integral and output values are clamped to safe min/max bounds to prevent wind-up or instability.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pid_struct</td><td>Pointer to the PID controller structure. </td></tr>
    <tr><td class="paramname">ref</td><td>Desired reference value (setpoint). </td></tr>
    <tr><td class="paramname">feedback</td><td>Current feedback value (measurement). </td></tr>
    <tr><td class="paramname">ff_model</td><td>Optional feedforward term added to the output. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Final, clamped output value from the controller. </dd></dl>

</div>
</div>
<a id="a81577a47369bdf873ab44bcacff40396" name="a81577a47369bdf873ab44bcacff40396"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a81577a47369bdf873ab44bcacff40396">&#9670;&#160;</a></span>HAL_HRTIM_RepetitionEventCallback()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void HAL_HRTIM_RepetitionEventCallback </td>
          <td>(</td>
          <td class="paramtype">HRTIM_HandleTypeDef *</td>          <td class="paramname"><span class="paramname"><em>hhrtim</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t</td>          <td class="paramname"><span class="paramname"><em>TimerIdx</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Main control loop callback called at each HRTIM repetition event. </p>
<p>This function is tied to a high-frequency hardware timer (HRTIM). It:</p><ul>
<li>Checks for ADC overruns and recovers if needed</li>
<li>Samples ADC data</li>
<li>Executes the main closed-loop control update</li>
</ul>
<p>This is where the entire feedback control logic is anchored, providing real-time regulation of current, power, and duty cycles for the supercap management system.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">hhrtim</td><td>Pointer to the HRTIM handle (unused here). </td></tr>
    <tr><td class="paramname">TimerIdx</td><td>Index of the timer triggering the event (unused). </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a2f0721213d637875e8d354705ca5e309" name="a2f0721213d637875e8d354705ca5e309"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2f0721213d637875e8d354705ca5e309">&#9670;&#160;</a></span>idle_mode()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void idle_mode </td>
          <td>(</td>
          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Transitions the system into idle mode safely. </p>
<p>Used during safety events or power-off conditions to gracefully exit the control loop. Ensures gates are off and no control loop logic executes. </p>

</div>
</div>
<a id="a3fdc9bc0c7f34cdfebf5ad8775557b8f" name="a3fdc9bc0c7f34cdfebf5ad8775557b8f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3fdc9bc0c7f34cdfebf5ad8775557b8f">&#9670;&#160;</a></span>loop_update()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void loop_update </td>
          <td>(</td>
          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Updates the control loop at each HRTIM callback cycle. </p>
<p>This function is the heart of the closed-loop control logic. It:</p><ul>
<li>Runs safety checks</li>
<li>Reads filtered sensor values</li>
<li>Computes a desired supercap current to keep battery power below limits</li>
<li>Computes duty cycle through cascaded PID loops with voltage clamping</li>
<li>Updates PWM outputs accordingly </li>
</ul>

</div>
</div>
<a id="a4f1940289143f288690030b42bd9bb40" name="a4f1940289143f288690030b42bd9bb40"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4f1940289143f288690030b42bd9bb40">&#9670;&#160;</a></span>low_pass_filter()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static float low_pass_filter </td>
          <td>(</td>
          <td class="paramtype">float</td>          <td class="paramname"><span class="paramname"><em>current_value</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float</td>          <td class="paramname"><span class="paramname"><em>previous_value</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float</td>          <td class="paramname"><span class="paramname"><em>alpha</em></span>&#160;)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>First-order low pass filter. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">current_value</td><td>New input value </td></tr>
    <tr><td class="paramname">previous_value</td><td>Previously filtered output </td></tr>
    <tr><td class="paramname">alpha</td><td>Filter constant (0 &lt; alpha &lt; 1) </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Filtered result </dd></dl>

</div>
</div>
<a id="adf3e99356aa7839ba54e74a5a15bb49d" name="adf3e99356aa7839ba54e74a5a15bb49d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adf3e99356aa7839ba54e74a5a15bb49d">&#9670;&#160;</a></span>moving_average()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static uint16_t moving_average </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structmov__avrg__filter.html">mov_avrg_filter</a> &amp;</td>          <td class="paramname"><span class="paramname"><em>filter</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t</td>          <td class="paramname"><span class="paramname"><em>new_sample</em></span>&#160;)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Calculates a moving average on a circular buffer filter structure. </p>
<p>The moving average filter stores a rolling window of past <code>n</code> samples and returns the average based on either the full window or current fill state. This is used for noise filtering of analog signals such as current and voltage before feeding them into PID loops.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">filter</td><td>The filter state structure (holds index, window buffer, etc.) </td></tr>
    <tr><td class="paramname">new_sample</td><td>The latest ADC sample to be added to the buffer </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Filtered (smoothed) 16-bit average value </dd></dl>

</div>
</div>
<a id="a96056a8046434e0683c4c4b5cce9c26e" name="a96056a8046434e0683c4c4b5cce9c26e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a96056a8046434e0683c4c4b5cce9c26e">&#9670;&#160;</a></span>safety_change_level()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void safety_change_level </td>
          <td>(</td>
          <td class="paramtype">uint8_t</td>          <td class="paramname"><span class="paramname"><em>Item</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t</td>          <td class="paramname"><span class="paramname"><em>Level</em></span>&#160;)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Safely updates the level of a safety item if required. </p>
<p>Changes the level only if escalating or recovering from a serious state.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Item</td><td>Index of the safety item. </td></tr>
    <tr><td class="paramname">Level</td><td>New safety level to apply. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="ae89ccaa857bc05c4a7c5d7725ac597dd" name="ae89ccaa857bc05c4a7c5d7725ac597dd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae89ccaa857bc05c4a7c5d7725ac597dd">&#9670;&#160;</a></span>safety_check_currents()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void safety_check_currents </td>
          <td>(</td>
          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Checks for overcurrent conditions on both the chassis and the supercapacitor. </p>
<p>Monitors the current flowing through the capacitor and the main gate. If the current exceeds the defined safe limits, the system transitions into idle mode.</p>
<p>Uses absolute values for current readings since direction doesn’t matter for safety. Only acts if the current error hasn't already reached its most critical state. </p>

</div>
</div>
<a id="aa6f1aee2abb42683116182bcd70bc2d9" name="aa6f1aee2abb42683116182bcd70bc2d9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa6f1aee2abb42683116182bcd70bc2d9">&#9670;&#160;</a></span>safety_check_voltages()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void safety_check_voltages </td>
          <td>(</td>
          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Performs safety checks on both chassis and supercapacitor voltages. </p>
<p>Uses counters for debounce behavior and disables the control loop if unsafe conditions persist (too high or low voltage on either side). </p>

</div>
</div>
<a id="aba3127849c2e3b057ae866a50726d0dc" name="aba3127849c2e3b057ae866a50726d0dc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aba3127849c2e3b057ae866a50726d0dc">&#9670;&#160;</a></span>sample_adc()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void sample_adc </td>
          <td>(</td>
          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Samples and filters ADC data from both ADC1 and ADC2. </p>
<p>This function determines which half of the DMA double-buffer is ready for each ADC, averages multiple samples per channel (to reduce noise), and applies a moving average filter to smooth the data before it's used for PID control and safety checks. </p>

</div>
</div>
<a id="a7dd54fc66122a231da37b565f13d23c5" name="a7dd54fc66122a231da37b565f13d23c5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7dd54fc66122a231da37b565f13d23c5">&#9670;&#160;</a></span>softwareReset()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void softwareReset </td>
          <td>(</td>
          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Forces a software reset of the MCU. </p>
<p>Software-triggered MCU reset function (called on fatal error or remote command).</p>
<p>Used during critical fault recovery to completely reboot the board. Disables interrupts and enters an infinite loop until the system reset is triggered via NVIC. </p>

</div>
</div>
<a id="a900e71684e129e79e1783534a3debe3b" name="a900e71684e129e79e1783534a3debe3b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a900e71684e129e79e1783534a3debe3b">&#9670;&#160;</a></span>stop_gates_pwm()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void stop_gates_pwm </td>
          <td>(</td>
          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Disables all HRTIM PWM outputs driving the power gates. </p>
<p>Forces an output disable through the HRTIM register. Used in safety shutdown and during idle transitions to prevent accidental switching activity. </p>

</div>
</div>
<a id="a96b593097aa92fa0833e7133289303d0" name="a96b593097aa92fa0833e7133289303d0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a96b593097aa92fa0833e7133289303d0">&#9670;&#160;</a></span>stop_loop()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void stop_loop </td>
          <td>(</td>
          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Internal version of loop stop (non-class variant). </p>
<p>Exists in addition to the class method for situations where non-member access is needed. </p>

</div>
</div>
<a id="a6b15df3bf8a89c80f9b0555a17081f5d" name="a6b15df3bf8a89c80f9b0555a17081f5d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6b15df3bf8a89c80f9b0555a17081f5d">&#9670;&#160;</a></span>update_dutyCycle()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void update_dutyCycle </td>
          <td>(</td>
          <td class="paramtype">float</td>          <td class="paramname"><span class="paramname"><em>dutyRatio</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Updates the duty cycle for both half-bridges using the HRTIM peripheral. </p>
<p>Based on the current ratio, calculates the appropriate compare values for each timer output. The cap and chassis sides are controlled separately using a normalized (0.0–1.0+) input ratio.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">dutyRatio</td><td>Desired duty ratio (V_cap / V_bat), expected to be in [0.0, 2.0] </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a510d23db2a669094d85a6db0f28c28fc" name="a510d23db2a669094d85a6db0f28c28fc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a510d23db2a669094d85a6db0f28c28fc">&#9670;&#160;</a></span>update_pid_maxpow()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void update_pid_maxpow </td>
          <td>(</td>
          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Updates the internal PID limits for chassis power. </p>
<p>This function is used internally to update the maximum allowed output and integration range for the chassis power PID controller. It ensures that the controller stays within competition-legal limits by capping both the integral term and final output. </p>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a46c7e940e741ba548759a21f902118a4" name="a46c7e940e741ba548759a21f902118a4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a46c7e940e741ba548759a21f902118a4">&#9670;&#160;</a></span>ADC_sampled_data</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint16_t ADC_sampled_data[5]</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Intermediate ADC buffer after averaging. </p>

</div>
</div>
<a id="aaecc091ac17639abe1eb50af6f0cb7fb" name="aaecc091ac17639abe1eb50af6f0cb7fb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aaecc091ac17639abe1eb50af6f0cb7fb">&#9670;&#160;</a></span>battery_current</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float battery_current = 0.0f</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a0bb2bcf0f70d5bb5657012d03d05ee4b" name="a0bb2bcf0f70d5bb5657012d03d05ee4b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0bb2bcf0f70d5bb5657012d03d05ee4b">&#9670;&#160;</a></span>cap_current</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float cap_current = 0.0f</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="aca6f1f4aeb1f4203dc361f5a66b5e785" name="aca6f1f4aeb1f4203dc361f5a66b5e785"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aca6f1f4aeb1f4203dc361f5a66b5e785">&#9670;&#160;</a></span>cap_voltage</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float cap_voltage = 0.0f</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="abe6e2082cb3bc83efd0c83f6c75adde1" name="abe6e2082cb3bc83efd0c83f6c75adde1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abe6e2082cb3bc83efd0c83f6c75adde1">&#9670;&#160;</a></span>chassis_voltage</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float chassis_voltage = 0.0f</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Extern global values for chassis voltage and battery current (used across control loops and diagnostics). </p>

</div>
</div>
<a id="adc0f512c64dfad893de755ec0dc721e0" name="adc0f512c64dfad893de755ec0dc721e0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adc0f512c64dfad893de755ec0dc721e0">&#9670;&#160;</a></span>current_mode</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="supercap__controllers_8hpp.html#aa0e9b7ff7bcdd512c6fe7530def28d17">Mode_ModeTypedef</a> current_mode = <a class="el" href="supercap__controllers_8hpp.html#aa0e9b7ff7bcdd512c6fe7530def28d17aebc81705969b8c5ae986b0b2ec08d1d5">normal</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Current control mode (normal, idle, etc.) </p>

</div>
</div>
<a id="a04670db48f9ecf425c973b0b4c42fa7e" name="a04670db48f9ecf425c973b0b4c42fa7e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a04670db48f9ecf425c973b0b4c42fa7e">&#9670;&#160;</a></span>duty_ratio</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float duty_ratio = 0.9f</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a60677df115fa0dc78ceaf25cc7adf6f3" name="a60677df115fa0dc78ceaf25cc7adf6f3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a60677df115fa0dc78ceaf25cc7adf6f3">&#9670;&#160;</a></span>duty_ratio_output</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float duty_ratio_output</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Raw PID output for duty ratio. </p>

</div>
</div>
<a id="ad8f99c940b2cbb9852469dc445d114fb" name="ad8f99c940b2cbb9852469dc445d114fb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad8f99c940b2cbb9852469dc445d114fb">&#9670;&#160;</a></span>I_supercap_last</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">float I_supercap_last = 0.0f</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Stores last supercap current reference. </p>

</div>
</div>
<a id="ac0e82031947d3d4d9f2cf037a5f95010" name="ac0e82031947d3d4d9f2cf037a5f95010"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac0e82031947d3d4d9f2cf037a5f95010">&#9670;&#160;</a></span>icap_output</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float icap_output</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>PID-calculated reference current for supercap. </p>

</div>
</div>
<a id="a2e86f659ad07cfa468b741a118bcae23" name="a2e86f659ad07cfa468b741a118bcae23"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2e86f659ad07cfa468b741a118bcae23">&#9670;&#160;</a></span>in_loop</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t in_loop = false</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>True if control is actively running. </p>

</div>
</div>
<a id="a1e54fa0af2d142c1cf2cec156e08e34b" name="a1e54fa0af2d142c1cf2cec156e08e34b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1e54fa0af2d142c1cf2cec156e08e34b">&#9670;&#160;</a></span>is_init</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t is_init = false</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Internal state variables for control loop execution. </p>
<p>True if control loop is initialized </p>

</div>
</div>
<a id="a0fd96139ccb71c248b4fe6a33a4226d0" name="a0fd96139ccb71c248b4fe6a33a4226d0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0fd96139ccb71c248b4fe6a33a4226d0">&#9670;&#160;</a></span>max_chassis_power</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t max_chassis_power = 45</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Max allowed chassis power under RMUC rules. </p>

</div>
</div>
<a id="af30d8fa4b89fd391c7c55037f2c66328" name="af30d8fa4b89fd391c7c55037f2c66328"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af30d8fa4b89fd391c7c55037f2c66328">&#9670;&#160;</a></span>out_duty_ratio_output</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float out_duty_ratio_output</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Clamped and validated duty ratio to apply. </p>

</div>
</div>
<a id="a55509e1a9816b26433393148b19e8dcf" name="a55509e1a9816b26433393148b19e8dcf"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a55509e1a9816b26433393148b19e8dcf">&#9670;&#160;</a></span>Pchassis_output</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float Pchassis_output</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Output variables used in control and monitoring. </p>
<p>Output power estimation to the chassis </p>

</div>
</div>
<a id="add29c3bfa7876f2b1d4b4685782829bb" name="add29c3bfa7876f2b1d4b4685782829bb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#add29c3bfa7876f2b1d4b4685782829bb">&#9670;&#160;</a></span>pid</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="struct_loop_ctrl___p_i_d.html">LoopCtrl_PID</a> pid[5]</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Array of PID control structures. </p>

</div>
</div>
<a id="a9ad0a1ea7261d776caf4fafe278338fb" name="a9ad0a1ea7261d776caf4fafe278338fb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9ad0a1ea7261d776caf4fafe278338fb">&#9670;&#160;</a></span>safetyChangeTrigger</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t safetyChangeTrigger</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Tracks whether a safety level transition occurred. </p>

</div>
</div>
<a id="a279987673281ac0b5a019326653e3520" name="a279987673281ac0b5a019326653e3520"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a279987673281ac0b5a019326653e3520">&#9670;&#160;</a></span>safetyItemLevel</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t safetyItemLevel[8]</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Tracks safety status per monitored item. </p>
<p>Global safety flags indexed by <a class="el" href="supercap__controllers_8hpp.html#ac22ba838cd4049682821877288724d79" title="Enumerates the various error detection sources used for safety monitoring.">Safety_DetectItemTypedef</a>. </p>

</div>
</div>
<a id="afc1d28cfbce795d6ea954ebe725241f5" name="afc1d28cfbce795d6ea954ebe725241f5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afc1d28cfbce795d6ea954ebe725241f5">&#9670;&#160;</a></span>temperature</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float temperature = 0.0f</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Global sensing variables updated during each loop. </p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_9af51e3826d4f9e80d9103b2de543e84.html">System</a></li><li class="navelem"><a class="el" href="dir_53074bd4658fc8773d86c3a2399e6abf.html">stm_utils</a></li><li class="navelem"><a class="el" href="dir_65af64983a4b6d60dee528c212a4ddcf.html">Src</a></li><li class="navelem"><a class="el" href="supercap__controllers_8cpp.html">supercap_controllers.cpp</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
